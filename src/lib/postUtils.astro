---
import { getCollection, type CollectionEntry } from "astro:content";

export async function getPosts() {
  const allPosts = (await getCollection("posts"))
    .filter((post) => post.data.published)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  if (allPosts.length > 0) {
    // Add a link to the next post in each post
    allPosts.forEach((post, index, array) => {
      post.data.previous =
        index < allPosts.length - 1 ? getPostData(array[index + 1]) : undefined;
      post.data.next = index > 0 ? getPostData(array[index - 1]) : undefined;
    });
  }
  return allPosts;
}

export async function getFeaturedPosts() {
  return (await getPosts()).filter((post) => post.data.featured);
}

export function getPostData(post: any) {
  return {
    slug: `/${post.collection}/${post.slug}`,
    title: post.data.title,
  };
}

export function formattedTime(time: string): string {
  if (!time) return "";

  // Remove any leading 0 before single digit hours
  const withoutLeadingZero = time.replace(/^0(\d:)/, "$1");

  // Remove space before AM/PM and convert to lowercase
  return withoutLeadingZero.replace(/\s*(AM|PM)/i, (match) =>
    match.trim().toLowerCase()
  );
}

export function getCollectionSlug(collection: string) {
  return collection;
}

export async function getTags(): Promise<string[]> {
  const allTags = new Set<string>();
  const allContent = await getPosts();

  allContent.forEach((item) => {
    item.data.tags?.forEach((tag: string) => allTags.add(tag));
  });

  return Array.from(allTags);
}
---
